# MetalFish Comparative Benchmark Workflow
# Compares MetalFish vs Stockfish vs LC0 and commits results to README.md

name: Comparative Benchmark

on:
  push:
    branches: main
  workflow_dispatch: # Allow manual trigger
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday

permissions:
  contents: write

jobs:
  # Build all three engines in parallel
  build-metalfish:
    name: Build MetalFish
    runs-on: macos-14
    steps:
      - name: Checkout MetalFish
        uses: actions/checkout@v4

      - name: Build MetalFish
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_METAL_SHADERS=ON
          cmake --build build --config Release -j$(sysctl -n hw.ncpu)

      - name: Upload MetalFish binary
        uses: actions/upload-artifact@v4
        with:
          name: metalfish-binary
          path: build/metalfish
          retention-days: 1

  build-stockfish:
    name: Build Stockfish
    runs-on: macos-14
    steps:
      - name: Checkout Stockfish
        uses: actions/checkout@v4
        with:
          repository: official-stockfish/Stockfish
          path: stockfish

      - name: Build Stockfish
        working-directory: stockfish/src
        run: |
          make -j$(sysctl -n hw.ncpu) build ARCH=apple-silicon

      - name: Upload Stockfish binary
        uses: actions/upload-artifact@v4
        with:
          name: stockfish-binary
          path: stockfish/src/stockfish
          retention-days: 1

  build-lc0:
    name: Build LC0
    runs-on: macos-14
    steps:
      - name: Install dependencies
        run: |
          brew install meson ninja protobuf eigen

      - name: Checkout LC0
        uses: actions/checkout@v4
        with:
          repository: LeelaChessZero/lc0
          path: lc0
          submodules: recursive

      - name: Build LC0
        working-directory: lc0
        run: |
          ./build.sh || {
            # Fallback build method
            meson setup build --buildtype=release -Dgtest=false || true
            cd build && ninja || true
          }

      - name: Find and upload LC0 binary
        run: |
          # Find the lc0 binary
          LC0_BIN=$(find lc0 -name "lc0" -type f -perm +111 2>/dev/null | head -1 || echo "")
          if [ -n "$LC0_BIN" ]; then
            cp "$LC0_BIN" ./lc0-binary
          else
            echo "LC0 build failed, creating placeholder"
            echo "#!/bin/bash" > ./lc0-binary
            echo "echo 'LC0 not available'" >> ./lc0-binary
            chmod +x ./lc0-binary
          fi

      - name: Upload LC0 binary
        uses: actions/upload-artifact@v4
        with:
          name: lc0-binary
          path: lc0-binary
          retention-days: 1

  # Run benchmarks on all three engines
  benchmark-metalfish:
    name: Benchmark MetalFish
    needs: build-metalfish
    runs-on: macos-14
    outputs:
      perft_nps: ${{ steps.bench.outputs.perft_nps }}
      search_nps: ${{ steps.bench.outputs.search_nps }}
      search_nodes: ${{ steps.bench.outputs.search_nodes }}
      gpu_status: ${{ steps.bench.outputs.gpu_status }}

    steps:
      - name: Download MetalFish
        uses: actions/download-artifact@v4
        with:
          name: metalfish-binary

      - name: Make executable
        run: chmod +x ./metalfish

      - name: System info
        run: |
          echo "=== System Info ===" | tee system_info.txt
          sw_vers | tee -a system_info.txt
          sysctl -n machdep.cpu.brand_string 2>/dev/null || echo "Apple Silicon" | tee -a system_info.txt
          system_profiler SPHardwareDataType | grep -E "Chip|Memory|Cores" | tee -a system_info.txt

      - name: Run Perft Benchmark
        id: perft
        run: |
          echo "=== MetalFish Perft ===" | tee perft.txt
          START=$(date +%s%N)
          {
            echo "position startpos"
            echo "perft 6"
            echo "quit"
          } | ./metalfish 2>&1 | tee -a perft.txt
          END=$(date +%s%N)

          # Calculate time
          TIME_MS=$(( (END - START) / 1000000 ))
          NODES=119060324
          NPS=$(( NODES * 1000 / (TIME_MS + 1) ))
          echo "perft_nps=$NPS" >> $GITHUB_OUTPUT

      - name: Run Search Benchmark
        id: bench
        run: |
          echo "=== MetalFish Search ===" | tee search.txt
          {
            echo "uci"
            echo "setoption name Hash value 256"
            echo "setoption name Threads value 1"
            echo "bench 14"
            echo "quit"
          } | timeout 300 ./metalfish 2>&1 | tee -a search.txt || true

          # Extract NPS
          SEARCH_NPS=$(grep -oE 'Nodes/second[[:space:]]*:[[:space:]]*[0-9]+' search.txt | grep -oE '[0-9]+' | tail -1 || echo "0")
          SEARCH_NODES=$(grep -oE 'Nodes searched[[:space:]]*:[[:space:]]*[0-9]+' search.txt | grep -oE '[0-9]+' | tail -1 || echo "0")

          # Get perft NPS from previous step
          echo "perft_nps=${{ steps.perft.outputs.perft_nps }}" >> $GITHUB_OUTPUT
          echo "search_nps=$SEARCH_NPS" >> $GITHUB_OUTPUT
          echo "search_nodes=$SEARCH_NODES" >> $GITHUB_OUTPUT

          # Check GPU status
          if grep -q "Metal device" search.txt; then
            echo "gpu_status=âœ… Active" >> $GITHUB_OUTPUT
          else
            echo "gpu_status=âŒ N/A" >> $GITHUB_OUTPUT
          fi

  benchmark-stockfish:
    name: Benchmark Stockfish
    needs: build-stockfish
    runs-on: macos-14
    outputs:
      perft_nps: ${{ steps.bench.outputs.perft_nps }}
      search_nps: ${{ steps.bench.outputs.search_nps }}
      search_nodes: ${{ steps.bench.outputs.search_nodes }}

    steps:
      - name: Download Stockfish
        uses: actions/download-artifact@v4
        with:
          name: stockfish-binary

      - name: Make executable
        run: chmod +x ./stockfish

      - name: Run Perft Benchmark
        id: perft
        run: |
          echo "=== Stockfish Perft ===" | tee perft.txt
          START=$(date +%s%N)
          {
            echo "position startpos"
            echo "go perft 6"
            echo "quit"
          } | ./stockfish 2>&1 | tee -a perft.txt
          END=$(date +%s%N)

          TIME_MS=$(( (END - START) / 1000000 ))
          NODES=119060324
          NPS=$(( NODES * 1000 / (TIME_MS + 1) ))
          echo "perft_nps=$NPS" >> $GITHUB_OUTPUT

      - name: Run Search Benchmark
        id: bench
        run: |
          echo "=== Stockfish Search ===" | tee search.txt
          {
            echo "uci"
            echo "setoption name Hash value 256"
            echo "setoption name Threads value 1"
            echo "bench 14"
            echo "quit"
          } | timeout 300 ./stockfish 2>&1 | tee -a search.txt || true

          # Get perft NPS
          echo "perft_nps=${{ steps.perft.outputs.perft_nps }}" >> $GITHUB_OUTPUT

          # Extract NPS from Stockfish bench output
          SEARCH_NPS=$(grep -oE 'Nodes/second[[:space:]]*:[[:space:]]*[0-9]+' search.txt | grep -oE '[0-9]+' | tail -1 || echo "0")
          SEARCH_NODES=$(grep -oE 'Nodes searched[[:space:]]*:[[:space:]]*[0-9]+' search.txt | grep -oE '[0-9]+' | tail -1 || echo "0")

          echo "search_nps=$SEARCH_NPS" >> $GITHUB_OUTPUT
          echo "search_nodes=$SEARCH_NODES" >> $GITHUB_OUTPUT

  benchmark-lc0:
    name: Benchmark LC0
    needs: build-lc0
    runs-on: macos-14
    outputs:
      search_nps: ${{ steps.bench.outputs.search_nps }}
      status: ${{ steps.bench.outputs.status }}

    steps:
      - name: Download LC0
        uses: actions/download-artifact@v4
        with:
          name: lc0-binary

      - name: Make executable
        run: chmod +x ./lc0-binary

      - name: Download small network
        run: |
          # Download a small network for testing
          curl -L -o network.pb.gz "https://training.lczero.org/get_network?sha=00af53b081e80147172e6f281c01571b49f5e0d733c5741c23c9adc89c3a6e8d" || true
          gunzip network.pb.gz 2>/dev/null || true

      - name: Run LC0 Benchmark
        id: bench
        run: |
          echo "=== LC0 Benchmark ===" | tee lc0.txt

          # Check if LC0 is available
          if ./lc0-binary --help 2>&1 | grep -q "not available"; then
            echo "LC0 not available"
            echo "search_nps=N/A" >> $GITHUB_OUTPUT
            echo "status=âŒ Build Failed" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Run LC0 with network if available
          if [ -f network.pb ]; then
            {
              echo "uci"
              echo "setoption name WeightsFile value network.pb"
              echo "setoption name Threads value 1"
              echo "position startpos"
              echo "go nodes 10000"
              echo "quit"
            } | timeout 60 ./lc0-binary 2>&1 | tee -a lc0.txt || true
          else
            echo "No network available"
            echo "search_nps=N/A" >> $GITHUB_OUTPUT
            echo "status=âš ï¸ No Network" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract NPS
          NPS=$(grep -oE 'nps [0-9]+' lc0.txt | grep -oE '[0-9]+' | tail -1 || echo "N/A")
          echo "search_nps=$NPS" >> $GITHUB_OUTPUT
          echo "status=âœ… Active" >> $GITHUB_OUTPUT

  # Collect results and update README
  update-readme:
    name: Update README with Results
    needs: [benchmark-metalfish, benchmark-stockfish, benchmark-lc0]
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT

      - name: Format numbers
        id: format
        run: |
          # Format large numbers with commas
          format_num() {
            echo "$1" | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta'
          }

          MF_PERFT="${{ needs.benchmark-metalfish.outputs.perft_nps }}"
          MF_SEARCH="${{ needs.benchmark-metalfish.outputs.search_nps }}"
          SF_PERFT="${{ needs.benchmark-stockfish.outputs.perft_nps }}"
          SF_SEARCH="${{ needs.benchmark-stockfish.outputs.search_nps }}"

          echo "mf_perft=$(format_num $MF_PERFT)" >> $GITHUB_OUTPUT
          echo "mf_search=$(format_num $MF_SEARCH)" >> $GITHUB_OUTPUT
          echo "sf_perft=$(format_num $SF_PERFT)" >> $GITHUB_OUTPUT
          echo "sf_search=$(format_num $SF_SEARCH)" >> $GITHUB_OUTPUT

      - name: Update README with benchmark results
        run: |
          cat > benchmark_section.md << 'BENCHMARK_EOF'
          ## ðŸ“Š Benchmark Results

          *Last updated: ${{ steps.date.outputs.date }} | Runner: GitHub Actions macos-14 (Apple Silicon)*

          ### Engine Comparison

          | Metric | MetalFish | Stockfish | LC0 |
          |--------|-----------|-----------|-----|
          | **Perft(6) NPS** | ${{ steps.format.outputs.mf_perft }} | ${{ steps.format.outputs.sf_perft }} | N/A |
          | **Search NPS** | ${{ steps.format.outputs.mf_search }} | ${{ steps.format.outputs.sf_search }} | ${{ needs.benchmark-lc0.outputs.search_nps }} |
          | **GPU Acceleration** | ${{ needs.benchmark-metalfish.outputs.gpu_status }} | âŒ CPU Only | ${{ needs.benchmark-lc0.outputs.status }} |

          ### MetalFish Details

          | Metric | Value |
          |--------|-------|
          | Perft(6) Nodes | 119,060,324 |
          | Perft NPS | ${{ steps.format.outputs.mf_perft }} |
          | Search NPS (depth 14) | ${{ steps.format.outputs.mf_search }} |
          | Total Search Nodes | ${{ needs.benchmark-metalfish.outputs.search_nodes }} |
          | GPU Status | ${{ needs.benchmark-metalfish.outputs.gpu_status }} |

          ### Notes
          - All benchmarks run on identical GitHub Actions `macos-14` runners (Apple Silicon)
          - Hash size: 256 MB, Threads: 1 (single-threaded for fair comparison)
          - MetalFish uses GPU acceleration via Metal for NNUE evaluation
          - Stockfish is the official build with Apple Silicon optimizations
          - LC0 requires neural network weights (may not build in CI)

          BENCHMARK_EOF

          # Replace the benchmark section in README
          if grep -q "## ðŸ“Š Benchmark Results" README.md; then
            # Use Python for reliable multi-line replacement
            python3 << 'PYTHON_EOF'
          import re

          with open('README.md', 'r') as f:
              content = f.read()

          with open('benchmark_section.md', 'r') as f:
              new_section = f.read()

          # Pattern to match the benchmark section until the next ## heading or end
          pattern = r'## ðŸ“Š Benchmark Results.*?(?=\n## (?!ðŸ“Š)|$)'

          if re.search(pattern, content, re.DOTALL):
              content = re.sub(pattern, new_section.strip(), content, flags=re.DOTALL)
          else:
              # Append before License section
              content = re.sub(r'(## License)', new_section + '\n\n\\1', content)

          with open('README.md', 'w') as f:
              f.write(content)
          PYTHON_EOF
          else
            # Append before License section
            python3 << 'PYTHON_EOF'
          import re

          with open('README.md', 'r') as f:
              content = f.read()

          with open('benchmark_section.md', 'r') as f:
              new_section = f.read()

          content = re.sub(r'(## License)', new_section + '\n\n\\1', content)

          with open('README.md', 'w') as f:
              f.write(content)
          PYTHON_EOF
          fi

          rm benchmark_section.md

      - name: Commit benchmark results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet README.md; then
            echo "No changes to commit"
          else
            git add README.md
            git commit -m "ðŸ“Š Update benchmark comparison [skip ci]

          MetalFish vs Stockfish vs LC0 comparison
          - MetalFish Perft NPS: ${{ steps.format.outputs.mf_perft }}
          - Stockfish Perft NPS: ${{ steps.format.outputs.sf_perft }}
          - GPU Status: ${{ needs.benchmark-metalfish.outputs.gpu_status }}"
            git push
          fi
